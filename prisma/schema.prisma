generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String              @id // Supabase Auth uid
  email     String              @unique
  name      String?
  nickname  String?
  role      String              @default("user") // 'user' | 'admin'
  createdAt DateTime            @default(now()) @map("created_at")
  sessions  SubmissionSession[]

  @@map("users")
}

model Challenge {
  id                 String              @id @default(cuid())
  title              String
  subtitle           String
  summary            String
  tags               String
  badge              String?
  difficulty         Int                 @default(1) // 1: 입문, 2: 중급, 3: 고급, 4: 전문가
  heroCopy           String?             @map("hero_copy")
  description        String
  cautionText        String?             @map("caution_text")
  datasetLabel       String?             @map("dataset_label")
  datasetFileName    String?             @map("dataset_file_name")
  datasetDescription String?             @map("dataset_description")
  datasetDownloadUrl String?             @map("dataset_download_url")
  restrictDatasetUrl Boolean             @default(false) @map("restrict_dataset_url")
  isPublished        Boolean             @default(false) @map("is_published")
  createdAt          DateTime            @default(now()) @map("created_at")
  questions          Question[]
  datasetUrls        DatasetUrl[]
  sessions           SubmissionSession[]

  @@map("challenges")
}

model DatasetUrl {
  id          String    @id @default(cuid())
  challengeId String    @map("challenge_id")
  url         String    @unique
  createdAt   DateTime  @default(now()) @map("created_at")
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@map("dataset_urls")
}

model Question {
  id          String    @id @default(cuid())
  challengeId String    @map("challenge_id")
  order       Int
  type        String
  prompt      String
  options     String?
  required    Boolean   @default(false)
  points      Int       @default(0)
  explanation String?
  createdAt   DateTime  @default(now()) @map("created_at")
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  answers     Answer[]

  @@unique([challengeId, order])
  @@map("questions")
}

model SubmissionSession {
  id             String    @id @default(cuid())
  userId         String?   @map("user_id")
  challengeId    String    @map("challenge_id")
  nickname       String
  status         String    @default("DRAFT")
  score          Int?
  totalQuestions Int?      @map("total_questions")
  createdAt      DateTime  @default(now()) @map("created_at")
  submittedAt    DateTime? @map("submitted_at")
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  challenge      Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  answers        Answer[]

  @@unique([challengeId, nickname])
  @@map("submission_sessions")
}

model Answer {
  id         String            @id @default(cuid())
  sessionId  String            @map("session_id")
  questionId String            @map("question_id")
  payload    String
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")
  session    SubmissionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question   Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, questionId])
  @@map("answers")
}

model Assessment {
  id               String                 @id @default(uuid())
  title            String
  description      String?
  companyName      String?                @map("company_name")
  createdBy        String?                @map("created_by")
  challengeId      String                 @map("challenge_id")
  accessCode       String                 @unique @map("access_code")
  timeLimitMinutes Int?                   @map("time_limit_minutes")
  expiresAt        DateTime?              @map("expires_at")
  isActive         Boolean                @default(true) @map("is_active")
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")
  submissions      AssessmentSubmission[]

  @@map("assessments")
}

model AssessmentSubmission {
  id             String             @id @default(uuid())
  assessmentId   String             @map("assessment_id")
  applicantName  String             @map("applicant_name")
  applicantEmail String             @map("applicant_email")
  status         String             @default("PENDING")
  score          Int?
  totalQuestions Int?               @map("total_questions")
  startedAt      DateTime?          @map("started_at")
  submittedAt    DateTime?          @map("submitted_at")
  createdAt      DateTime           @default(now()) @map("created_at")
  assessment     Assessment         @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  answers        AssessmentAnswer[]

  @@unique([assessmentId, applicantEmail])
  @@map("assessment_submissions")
}

model AssessmentAnswer {
  id           String               @id @default(uuid())
  submissionId String               @map("submission_id")
  questionId   String               @map("question_id")
  answerText   String?              @map("answer_text")
  isCorrect    Boolean?             @map("is_correct")
  createdAt    DateTime             @default(now()) @map("created_at")
  submission   AssessmentSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, questionId])
  @@map("assessment_answers")
}
